fix most tests and logic
